<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excel Formula Helper</title>
    <script type="module" src="/components/app-layout.js"></script>

    <!-- CodeMirror base + folding styles -->
    <link rel="stylesheet" href="https://esm.sh/@codemirror/view/style.css" />
    <link rel="stylesheet" href="https://esm.sh/@codemirror/fold/style.css" />

    <style>
      @import url("/unified-theme.css");

      .editor-wrapper {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        background: #1e293b;
        overflow: hidden;
        height: min(400px, calc(100vh - 300px));
      }

      #editor {
        height: 100%;
      }

      /* Rainbow brackets */
      .cm-b1 { color: #ef4444; }
      .cm-b2 { color: #f59e0b; }
      .cm-b3 { color: #22c55e; }
      .cm-b4 { color: #3b82f6; }
      .cm-b5 { color: #a855f7; }

      .cm-errorBracket {
        text-decoration: underline wavy var(--danger);
      }
    </style>

    <script type="module">
      import {
        EditorState,
        RangeSetBuilder,
      } from "https://esm.sh/@codemirror/state";
      import {
        Decoration,
        EditorView,
        keymap,
        lineNumbers,
        ViewPlugin,
        hoverTooltip,
      } from "https://esm.sh/@codemirror/view";
      import { defaultKeymap } from "https://esm.sh/@codemirror/commands";
      import {
        foldGutter,
        foldService,
        LanguageSupport,
        LRLanguage,
        syntaxHighlighting,
      } from "https://esm.sh/@codemirror/language";
      import { autocompletion } from "https://esm.sh/@codemirror/autocomplete";
      import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark";
      import { HighlightStyle } from "https://esm.sh/@codemirror/language";
      import { tags } from "https://esm.sh/@lezer/highlight";
      import { parser as jsParser } from "https://esm.sh/@lezer/javascript";

      /**************** Language (Lezer, JS-based) ****************/

      const excelLanguage = LRLanguage.define({ parser: jsParser });

      const excelHighlight = HighlightStyle.define([
        { tag: tags.function(tags.variableName), color: "#d8b4fe" },
        { tag: tags.number, color: "#fca5a5" },
        { tag: tags.string, color: "#86efac" },
        { tag: tags.operator, color: "#93c5fd" },
      ]);

      function excel() {
        return new LanguageSupport(excelLanguage, [
          syntaxHighlighting(excelHighlight),
        ]);
      }

      function parseExcelFormula(text) {
        return jsParser.parse(
          text.startsWith("=") ? text.slice(1) : text,
        );
      }

      /**************** Data & Autocompletion ****************/

      let formulaData = null;
      let formulaMap = new Map();

      async function loadFormulaData() {
        if (formulaData) return;
        try {
          const res = await fetch("./excel-formula-data.json");
          if (!res.ok) throw new Error("Failed to load formula data");
          formulaData = await res.json();
          // Create a map for quick lookup
          for (const item of formulaData) {
            formulaMap.set(item.name.toUpperCase(), item);
          }
        } catch (e) {
          console.error("Error loading formula data:", e);
          formulaData = [];
        }
      }

      const excelCompletion = async (context) => {
        const word = context.matchBefore(/[a-zA-Z0-9_.]*/);
        if (!word || (word.from === word.to && !context.explicit)) return null;

        if (!formulaData) {
          await loadFormulaData();
        }

        return {
          from: word.from,
          options: formulaData.map((item) => ({
            label: item.name,
            type: "function",
            detail: item.type,
            info: item.description,
          })),
        };
      };

      /**************** Hover Tooltip ****************/

      const formulaTooltip = hoverTooltip(async (view, pos, side) => {
        if (!formulaData) await loadFormulaData();

        const { from, to, text } = view.state.doc.lineAt(pos);
        let start = pos, end = pos;
        while (start > from && /\w/.test(text[start - from - 1])) start--;
        while (end < to && /\w/.test(text[end - from])) end++;
        
        if ((start === pos && side < 0) || (end === pos && side > 0)) return null;
        
        const word = text.slice(start - from, end - from).toUpperCase();
        const info = formulaMap.get(word);
        
        if (!info) return null;

        return {
          pos: start,
          end,
          above: true,
          create(view) {
            const dom = document.createElement("div");
            dom.style.padding = "4px 8px";
            dom.innerHTML = `<strong>${info.name}</strong> <span style="opacity: 0.7; font-size: 0.9em">(${info.type})</span><br>${info.description}`;
            return { dom };
          }
        };
      });

      /**************** AST-driven rainbow brackets ****************/

      const astRainbow = ViewPlugin.fromClass(
        class {
          decorations;
          constructor(view) {
            this.decorations = this.build(view);
          }
          update(u) {
            if (u.docChanged) this.decorations = this.build(u.view);
          }
          build(view) {
            const b = new RangeSetBuilder();
            const text = view.state.doc.toString();
            const tree = parseExcelFormula(text);
            const offset = text.startsWith("=") ? 1 : 0;
            let depth = 0;

            tree.iterate({
              enter: (n) => {
                if (n.name === "ArgList" || n.name === "ParenthesizedExpression") {
                  // ArgList children: '(', args..., ')'
                  // We need to identify the parentheses positions.
                  // For simplicity in this structure, we can just highlight the first and last chars of the node
                  // But checking children is more accurate.
                  // However, let's stick to the previous simple approach but use ArgList too.
                  // Since ArgList includes the parens at boundaries:
                  const cls = `cm-b${(depth % 5) + 1}`;
                  b.add(
                    n.from + offset,
                    n.from + offset + 1,
                    Decoration.mark({ class: cls }),
                  );
                  b.add(
                    n.to - 1 + offset,
                    n.to + offset,
                    Decoration.mark({ class: cls }),
                  );
                  depth++;
                }
              },
              leave: (n) => {
                if (n.name === "ArgList" || n.name === "ParenthesizedExpression") depth--;
              },
            });
            return b.finish();
          }
        },
        { decorations: (v) => v.decorations },
      );

      /**************** AST-based folding (Improved) ****************/

      const astFolding = foldService.of((state, lineStart) => {
        const text = state.doc.toString();
        const tree = parseExcelFormula(text);
        const offset = text.startsWith("=") ? 1 : 0;
        let found = null;

        tree.iterate({
          enter: (n) => {
            if (n.name === "ArgList" || n.name === "ParenthesizedExpression") {
              const from = n.from + offset;
              const line = state.doc.lineAt(from);
              if (line.from === lineStart && !found) {
                found = { from: from + 1, to: n.to - 1 + offset };
              }
            }
          },
        });
        return found;
      });

      /**************** Formatter / Minifier ****************/

      function minifyFormula(input) {
        return input.replace(/\s+/g, "");
      }

      function formatFormula(input) {
        const clean = minifyFormula(input);
        let depth = 0;
        let out = "";
        for (const ch of clean) {
          if (ch === "(") out += "(\n" + "  ".repeat(++depth);
          else if (ch === ")") out += "\n" + "  ".repeat(--depth) + ")";
          else if (ch === ",") out += ",\n" + "  ".repeat(depth);
          else out += ch;
        }
        return out.trim();
      }

      /**************** Bootstrap ****************/

      window.addEventListener("DOMContentLoaded", () => {
        const editorParent = document.getElementById("editor");
        const formatBtn = document.getElementById("formatBtn");
        const minifyBtn = document.getElementById("minifyBtn");

        // Trigger lazy load immediately (non-blocking)
        loadFormulaData();

        const state = EditorState.create({
          doc: "=IF(A1>10,SUM(A1:A10),AVERAGE(B1:B10))",
          extensions: [
            lineNumbers(),
            foldGutter({ openText: "▾", closedText: "▸" }),
            keymap.of(defaultKeymap),
            excel(),
            oneDark, // ✅ official CodeMirror dark theme
            astRainbow,
            astFolding,
            autocompletion({ override: [excelCompletion] }),
            formulaTooltip,
            EditorView.theme({ "&": { height: "100%" } }),
          ],
        });

        const view = new EditorView({ state, parent: editorParent });

        formatBtn.addEventListener("click", () => {
          view.dispatch({
            changes: {
              from: 0,
              to: view.state.doc.length,
              insert: formatFormula(view.state.doc.toString()),
            },
          });
        });

        minifyBtn.addEventListener("click", () => {
          view.dispatch({
            changes: {
              from: 0,
              to: view.state.doc.length,
              insert: minifyFormula(view.state.doc.toString()),
            },
          });
        });
      });
    </script>
  </head>
  <body>
    <app-layout title="Excel Formula Studio">
      <div class="space-y-6">
        <div class="card p-0 overflow-hidden">
          <div class="editor-wrapper">
            <div id="editor"></div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="formatBtn" class="btn btn-primary">Format Formula</button>
          <button id="minifyBtn" class="btn btn-secondary">Minify</button>
        </div>
        <p class="text-sm text-gray-500">
          Build and test complex Excel formulas with syntax highlighting, rainbow brackets, and autocompletion.
        </p>
      </div>
    </app-layout>
  </body>
</html>
