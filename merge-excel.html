<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Merger Utility</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS Library -->
    <script
      src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"
    ></script>
    <!-- Load Inter Font -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f7f9;
      }
      /* Custom scrollbar styling for the file list */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <!-- The entire application is now rendered by this single custom element -->
    <excel-merger-app
      class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-6 border border-gray-100 block"
    >
    </excel-merger-app>

    <script type="module">
      // Import Lit-HTML for templating and Haunted for web hooks
      import {
        component,
        useEffect,
        useState,
      } from "https://unpkg.com/haunted?module";
      import { html } from "https://unpkg.com/lit-html@2.0.0/lit-html.js";

      // Global environment variables (required, but not used for Firebase in this app)
      const appId = typeof __app_id !== "undefined"
        ? __app_id
        : "default-app-id";
      const firebaseConfig = typeof __firebase_config !== "undefined"
        ? JSON.parse(__firebase_config)
        : {};
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // --- Utility Functions (Adapted for Component Scope) ---

      /** Reads a file asynchronously and returns its ArrayBuffer content. */
      function readFileAsync(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) =>
            reject(new Error("Failed to read file: " + file.name));
          reader.readAsArrayBuffer(file);
        });
      }

      /** Sanitizes a filename to create a clean prefix for sheet names. */
      function sanitizeFilename(filename) {
        const name = filename.replace(/\.[^/.]+$/, "");
        return name.substring(0, 20).replace(/[^a-zA-Z0-9]/g, "_");
      }

      // --- Haunted Functional Component ---

      function ExcelMergerApp() {
        // State initialization using Haunted's useState hook
        const [selectedFiles, setSelectedFiles] = useState([]);
        const [isProcessing, setIsProcessing] = useState(false);
        const [statusMessage, setStatusMessage] = useState(
          "Please select files above.",
        );
        const [includeStyles, setIncludeStyles] = useState(true);
        const [downloadUrl, setDownloadUrl] = useState(null);
        const [dropZoneHighlight, setDropZoneHighlight] = useState(
          false,
        );

        // Effect to manage the status message and download link based on file selection
        useEffect(() => {
          setDownloadUrl(null); // Reset download link on file change

          if (selectedFiles.length > 0) {
            setStatusMessage(
              `${selectedFiles.length} Excel file(s) selected. Ready to merge.`,
            );
          } else {
            setStatusMessage("Please select files above.");
          }
        }, [selectedFiles]);

        // --- Handlers ---

        /** Handles file selection from input or drop events */
        const handleFileSelection = (files) => {
          const validFiles = Array.from(files).filter((file) =>
            file.name.toLowerCase().endsWith(".xlsx") ||
            file.name.toLowerCase().endsWith(".xls")
          );
          setSelectedFiles(validFiles);
        };

        /** Handles changes from the file input element */
        const handleFileChange = (e) => {
          handleFileSelection(e.target.files);
          e.target.value = null; // Reset input field
        };

        /** Handles file dropping into the drop zone */
        const handleDrop = (e) => {
          e.preventDefault();
          setDropZoneHighlight(false);
          handleFileSelection(e.dataTransfer.files);
        };

        /** Core Merge Logic */
        const mergeFiles = async () => {
          if (selectedFiles.length === 0 || isProcessing) return;

          setIsProcessing(true);
          setDownloadUrl(null);
          setStatusMessage("Merging files... This may take a moment.");

          const styleOption = includeStyles ? { cellStyles: true } : {};

          try {
            const outputWorkbook = XLSX.utils.book_new();
            const usedSheetNames = new Set();
            let totalSheetsAdded = 0;

            for (const file of selectedFiles) {
              setStatusMessage(`Processing file: ${file.name}...`);

              const data = await readFileAsync(file);

              const inputWorkbook = XLSX.read(data, {
                type: "array",
                ...styleOption,
              });
              const filePrefix = sanitizeFilename(file.name);

              for (const sheetName of inputWorkbook.SheetNames) {
                const originalSheetName = sheetName;
                let newSheetName = originalSheetName;

                // Sheet Name Clash Handling (prepends filename if needed)
                if (usedSheetNames.has(newSheetName)) {
                  newSheetName = `${filePrefix}_${originalSheetName}`;

                  let counter = 1;
                  let finalName = newSheetName;
                  while (
                    usedSheetNames.has(finalName) && counter < 100
                  ) {
                    const truncatedBase = newSheetName.substring(
                      0,
                      31 - String(counter).length,
                    );
                    finalName = `${truncatedBase}${counter++}`;
                  }
                  newSheetName = finalName;
                }

                if (newSheetName.length > 31) {
                  newSheetName = newSheetName.substring(0, 31);
                }

                const worksheet =
                  inputWorkbook.Sheets[originalSheetName];
                XLSX.utils.book_append_sheet(
                  outputWorkbook,
                  worksheet,
                  newSheetName,
                );
                usedSheetNames.add(newSheetName);
                totalSheetsAdded++;
              }
            }

            setStatusMessage(
              `Generating final file with ${totalSheetsAdded} sheets...`,
            );

            const wbout = XLSX.write(outputWorkbook, {
              bookType: "xlsx",
              type: "array",
            });
            const blob = new Blob([wbout], {
              type: "application/octet-stream",
            });

            const url = URL.createObjectURL(blob);
            setDownloadUrl(url);

            setStatusMessage(
              `Merge complete! ${totalSheetsAdded} sheets combined. Styles: ${
                includeStyles ? "Included" : "Ignored"
              }.`,
            );
          } catch (error) {
            console.error("Merge error:", error);
            setStatusMessage(
              `An error occurred during merge: ${error.message}`,
            );
            setDownloadUrl(null);
          } finally {
            setIsProcessing(false);
          }
        };

        // --- Template Rendering (Lit-HTML) ---

        const mergeButtonText = isProcessing
          ? html`
            <div class="flex items-center justify-center">
              <svg
                class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                >
                </circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                >
                </path>
              </svg>
              Merging Sheets...
            </div>
          `
          : "Merge and Download Combined File";

        const dropZoneClasses = `
                p-5 bg-gray-50 border-2 border-dashed rounded-lg transition duration-300 
                ${
          dropZoneHighlight
            ? "border-blue-500 bg-blue-100"
            : "border-gray-300 hover:border-blue-400"
        }
            `;

        return html`
          <header class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-gray-800">Excel Sheet Combiner</h1>
            <p class="text-gray-500">
              Merge sheets from multiple Excel files into a single output file,
              optionally preserving cell formatting.
            </p>
          </header>

          <!-- Status Message -->
          <div
            id="status-message"
            class="text-sm text-center font-medium h-6 text-gray-600"
          >
            ${statusMessage}
          </div>

          <div class="space-y-6">
            <!-- File Upload & List -->
            <div>
              <!-- File Input Area (Drop Zone) -->
              <div
                class="${dropZoneClasses}"
                @dragover="${(e) => {
                  e.preventDefault();
                  setDropZoneHighlight(true);
                  setStatusMessage("Drop your Excel files here...");
                }}"
                @dragleave="${() => {
                  setDropZoneHighlight(false);
                  setStatusMessage(
                    selectedFiles.length > 0
                      ? `${selectedFiles.length} Excel file(s) selected. Ready to merge.`
                      : "Please select files above.",
                  );
                }}"
                @drop="${handleDrop}"
              >
                <label for="file-input" class="cursor-pointer block text-center">
                  <div class="flex flex-col items-center justify-center">
                    <svg
                      class="w-8 h-8 text-gray-400 mb-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4.903M15 15l-3-3m0 0l-3 3m3-3v9"
                      >
                      </path>
                    </svg>
                    <p class="text-sm font-medium text-gray-700">
                      Drag & Drop files here or Click to upload
                    </p>
                    <p class="text-xs text-gray-500">
                      Select .xlsx or .xls files (Multiple allowed)
                    </p>
                  </div>
                  <input
                    type="file"
                    id="file-input"
                    accept=".xlsx, .xls"
                    multiple
                    class="hidden"
                    @change="${handleFileChange}"
                  >
                </label>
              </div>

              <!-- File List -->
              ${selectedFiles.length > 0
                ? html`
                  <div
                    id="file-list-container"
                    class="mt-4 max-h-40 overflow-y-auto custom-scrollbar border border-gray-200 rounded-lg"
                  >
                    <ul id="file-list" class="divide-y divide-gray-100">
                      ${selectedFiles.map((file) =>
                        html`
                          <li class="p-3 flex justify-between items-center text-gray-700">
                            <span class="truncate">${file.name}</span>
                            <span class="text-xs text-gray-400 ml-2">${(file
                              .size / 1024).toFixed(1)} KB</span>
                          </li>
                        `
                      )}
                    </ul>
                  </div>
                `
                : html`
                  <div id="file-list-container" class="mt-4 hidden"></div>
                `}
            </div>

            <!-- Controls & Actions -->
            <div class="space-y-4 pt-2">
              <!-- Style Toggle -->
              <div
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200"
              >
                <label
                  for="style-toggle"
                  class="text-sm font-medium text-gray-700 flex flex-col cursor-pointer"
                >
                  Preserve Cell Styles
                  <span class="text-xs text-gray-500 font-normal mt-0.5"
                  >Includes colors, fonts, borders, etc. (Slower)</span>
                </label>
                <input
                  type="checkbox"
                  id="style-toggle"
                  .checked="${includeStyles}"
                  @change="${(e) => setIncludeStyles(e.target.checked)}"
                  class="
                    relative h-6 w-11 rounded-full cursor-pointer transition-colors duration-300 ease-in-out
                    appearance-none
                    bg-gray-300 checked:bg-green-500
                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500
                  "
                  style="--tw-ring-offset-color: #f7f7f9;"
                />
              </div>

              <!-- Action Button: Merge -->
              <button
                id="merge-button"
                @click="${mergeFiles}"
                .disabled="${selectedFiles.length === 0 ||
                  isProcessing}"
                class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md transition duration-300 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                ${mergeButtonText}
              </button>

              <!-- Download Link -->
              ${downloadUrl
                ? html`
                  <div
                    id="download-container"
                    class="text-center p-4 border border-green-300 bg-green-50 rounded-lg"
                  >
                    <a
                      id="download-link"
                      href="${downloadUrl}"
                      download="combined_excel_file.xlsx"
                      class="text-green-700 font-semibold hover:text-green-800 transition duration-150 flex items-center justify-center space-x-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        >
                        </path>
                      </svg>
                      <span>Download combined_excel_file.xlsx</span>
                    </a>
                  </div>
                `
                : html`
                  <div id="download-container" class="hidden"></div>
                `}
            </div>
          </div>
        `;
      }

      // Define the custom element using Haunted's component wrapper
      customElements.define(
        "excel-merger-app",
        component(ExcelMergerApp, { useShadowDOM: false }),
      );
    </script>
  </body>
</html>
